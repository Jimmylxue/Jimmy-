(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{495:function(s,n,a){"use strict";a.r(n);var e=a(4),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"koa-2框架中接收文件，实现文件上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#koa-2框架中接收文件，实现文件上传"}},[s._v("#")]),s._v(" Koa 2框架中接收文件，实现文件上传")]),s._v(" "),a("blockquote",[a("p",[s._v("文件上传这个操作是非常非常常用的，如果是使用JS直接写一个文件上传的代码的代码量是巨大的，且不容易理解，这里我也是在网上查了很久，可以使用"),a("code",[s._v("koa-multer")]),s._v("插件来实现文件上传")])]),s._v(" "),a("h3",{attrs:{id:"传统的文件上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#传统的文件上传"}},[s._v("#")]),s._v(" 传统的文件上传")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("我过去的做法是先将然后文件全部转码成Base64的一长串字符串，将这一长串字符串传给后端，后端再根据字符串，使用"),a("code",[s._v("Buffer.from")]),s._v("逆解析，最终将图片保存在服务器上，我自己理解的这样的作法有以下的几点不好。")]),s._v(" "),a("ol",[a("li",[s._v("因为是将整个Base64字符串传递给后端，就会造成一个接口传递的数据量是500k上下甚至1M，极其的消耗性能")]),s._v(" "),a("li",[s._v("需要做逆解析，使用path模块保存图片，等等操作，代码量极其的繁琐。")])])]),s._v(" "),a("li",[a("p",[s._v("但是我还是写出来了，代码量过于庞大，这样写和脑溢血没有区别：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  const router = require('koa-router')()\n  const fs = require('fs')\n  const { resolve } = require('path')\n\n  // 获取目录，目的是方便后期存储\n  router.get('/getDir', async ctx => {\n    let objPath = resolve(__dirname, '../static')\n    let dir = fs.readdirSync(objPath)\n    ctx.body = { code: 200, message: '请求成功', result: dir }\n  })\n  \n  router.post('/getImgs', async ctx => {\n    let imgComponents = []\n    let objPath = resolve(__dirname, '../static')\n    fs.readdirSync(objPath).map(item => {\n      let json = {}\n      json.name = item\n      let newPath = resolve(objPath, item)\n      let anser = fs.readdirSync(newPath)\n      json.url = anser\n      imgComponents.push(json)\n    })\n    // map和forEach的区别 都是遍历数组元素  map会直接影响本身\n    imgComponents.map(item => {\n      item.url.map(function (items) {\n        this.items = 'http://127.0.0.1:666/' + items\n      })\n    })\n    ctx.body = {\n      code: 200,\n      message: '请求成功',\n      result: imgComponents,\n    }\n  })\n\n  // 上传的关键性代码\n  router.post('/uploadImgs', async ctx => {\n    let { filename, files } = ctx.request.body\n    // console.log(filename, files)\n    try {\n      files.map(item => {\n        let extend = '.' + item.imgname.split(';')[0].split('/')[1]\n        let img = Buffer.from(item.imgsrc, 'base64')\n        let imgname = `${Date.now()}${extend}`\n        let imgpostiton = resolve(__dirname, `../static/${filename}/${imgname}`)\n        fs.writeFileSync(imgpostiton, img)\n      })\n    } catch {\n      ctx.body = { code: 0, message: '添加失败' }\n    }\n    ctx.body = { code: 200, message: '请求成功' }\n  })\n  \n  // 删除\n  router.post('/delImg', async ctx => {\n    let { dir, filename } = ctx.request.body\n    // console.log(dir, filename)\n    let objdir = resolve(__dirname, `../static/${dir}/${filename}`)\n    // console.log(objdir)\n    try {\n      fs.unlinkSync(objdir)\n    } catch {\n      ctx.body = { code: 0, message: '删除失败' }\n    }\n    ctx.body = { code: 200, message: '操作成功' }\n  })\n\n  module.exports = router.routes()\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"使用koa-multer插件实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用koa-multer插件实现"}},[s._v("#")]),s._v(" 使用"),a("code",[s._v("koa-multer")]),s._v("插件实现")]),s._v(" "),a("blockquote",[a("p",[s._v("现在我们上传文件一边前后台都会使用插件，如前台我们使用element-UI，后台使用koa-multer")])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("前台传递给后台的数据类型是file - (binary)")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20201122224203192.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjI0MDE2Mg==,size_16,color_FFFFFF,t_70#pic_center",alt:"传递的数据类型"}})]),s._v(" "),a("p",[s._v("因为是file的二进制数据流，所以使用Koa框架的时候是没有办法直接在"),a("code",[s._v("ctx.request.body")]),s._v("中获取的，就需要使用"),a("code",[s._v("koa-multer")]),s._v("插件注入到路由中，在路由的时候完成保存图片的操作")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  1. 配置 multer 中间键\n\n  const multer = require('koa-multer')\n\n  let storage = multer.diskStorage({\n    //文件保存路径 这个路由是以项目文件夹 也就是和入口文件（如app.js同一个层级的）\n    destination: function (req, file, cb) {\n        cb(null, 'static/base/')\n    },\n    //修改文件名称\n    filename: function (req, file, cb) {\n        let fileFormat = (file.originalname).split(\".\");  //以点分割成数组，数组的最后一项就是后缀名\n        cb(null, 'Jimmy'+Date.now() + \".\" + fileFormat[fileFormat.length - 1]);\n    }\n  })\n\n  let upload = multer({\n    storage: storage,\n    limits: {\n      fileSize: 1024*1024/2 // 限制512KB  \n    }\n  });\n\n  module.exports = upload\n\n  2. 在路由中使用\n\n  const router = require('koa-router')()\n\n  const upload = require('../common/uploadConfig')  // 引入我们的中间键\n\n  // 在路由的时候注入，之后只要这个路由一走，就会自动的将我们的图片上传到服务器，并且保存到我们 upload 中间键配置的保存文件目录下\n  router.post('/gallery',upload.single('file'),async ctx=>{\n    console.log('new data',ctx.req.file.filename)\n\n    ctx.body = {code:200,result:'请求成功',filename:ctx.req.file.filename}\n  })\n\n  module.exports = router.routes()\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"文件上传在有了插件之后开发真的是方便多了，站在巨人的肩膀上编程。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件上传在有了插件之后开发真的是方便多了，站在巨人的肩膀上编程。"}},[s._v("#")]),s._v(" 文件上传在有了插件之后开发真的是方便多了，站在巨人的肩膀上编程。")])])}),[],!1,null,null,null);n.default=t.exports}}]);